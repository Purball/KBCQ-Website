<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KBCQ Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfsNVnz82BM1KvQuksXywK8nLqgcdC4-o",
      authDomain: "kbcq-e3a4f.firebaseapp.com",
      projectId: "kbcq-e3a4f",
      storageBucket: "kbcq-e3a4f.firebasestorage.app",
      messagingSenderId: "763431750367",
      appId: "1:763431750367:web:f0df6a15426298b8fbf76a",
      measurementId: "G-83GG3HYTXP"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    body{background:#f7e4b0;font-family:'Segoe UI',sans-serif;padding:2rem;color:#1d3a47}
    h1{text-align:center;color:#e63b2f;margin-bottom:1rem;text-shadow:0 2px 8px rgba(255,255,255,0.7)}
    .admin-panel{max-width:800px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);padding:2rem}
    input,textarea,select{width:100%;padding:.8rem;margin-bottom:.8rem;border-radius:6px;border:1px solid #ccc}
    button{background:#ff7954;color:#fff;border:none;padding:.8rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600}
    button:hover{background:#2c6e91}
    .review-item{background:#fff4f2;border-radius:8px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.15);margin-bottom:1rem;position:relative}
    .review-item button{position:absolute;top:.5rem;background:none;border:none;font-weight:bold;cursor:pointer}
    .edit-btn{right:2.5rem;color:#2c6e91}
    .delete-btn{right:.5rem;color:#e63b2f}
  </style>
</head>
<body>
  <h1>ü¶Ä KBCQ Admin Dashboard</h1>

  <div class="admin-panel" id="admin-panel">
    <div id="auth-section" class="login-form">
      <h3>Sign In</h3>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="login">Sign In</button>
      <p id="login-status" style="margin-top:1rem;color:#333;"></p>
    </div>

    <button id="logout" style="display:none;">Logout</button>

    <div class="review-form" id="review-form" style="display:none;">
      <h3>Add / Update Review</h3>
      <input type="hidden" id="review-id" />
      <input type="text" id="review-title" placeholder="Review title" required />
      <input type="text" id="review-location" placeholder="Restaurant / Location" required />
      <input type="text" id="review-tag" placeholder="Restaurant tag (e.g., @bluewatergrillfl)" />
      <textarea id="review-text" placeholder="Review text..." required></textarea>
      <select id="review-rating" required>
        <option value="">Select Rating</option>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
        <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
        <option value="2">‚≠ê‚≠ê (2)</option>
        <option value="1">‚≠ê (1)</option>
      </select>
      <input type="number" id="review-lat" placeholder="Latitude (optional)" step="any" />
      <input type="number" id="review-lon" placeholder="Longitude (optional)" step="any" />
      <input type="file" id="review-photos" multiple accept="image/*" />
      <button id="save-review">Save Review</button>
      <p id="save-status" style="margin-top:1rem;font-weight:bold;"></p>
    </div>

    <div class="review-list" id="review-list" style="display:none;">
      <h3>Existing Reviews</h3>
      <div id="reviews-container-admin"></div>
    </div>
  </div>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const loginBtn=document.getElementById('login');
    const logoutBtn=document.getElementById('logout');
    const emailField=document.getElementById('email');
    const passField=document.getElementById('password');
    const loginStatus=document.getElementById('login-status');

    const reviewForm=document.getElementById('review-form');
    const reviewList=document.getElementById('review-list');

    loginBtn.addEventListener('click',async()=>{
      const email=emailField.value.trim();
      const pass=passField.value.trim();
      if(!email||!pass){loginStatus.textContent="Enter email and password.";loginStatus.style.color="red";return;}
      try{await auth.signInWithEmailAndPassword(email,pass);}catch(err){
        if(err.code==='auth/user-not-found'){
          await auth.createUserWithEmailAndPassword(email,pass);
          loginStatus.textContent="New admin user created.";loginStatus.style.color="green";
        }else{loginStatus.textContent=err.message;loginStatus.style.color="red";}
      }
    });

    logoutBtn.addEventListener('click',()=>auth.signOut());

    auth.onAuthStateChanged(user=>{
      if(user){
        document.getElementById('auth-section').style.display='none';
        logoutBtn.style.display='inline-block';
        reviewForm.style.display='block';
        reviewList.style.display='block';
        loadReviews();
      }else{
        document.getElementById('auth-section').style.display='block';
        logoutBtn.style.display='none';
        reviewForm.style.display='none';
        reviewList.style.display='none';
      }
    });

    document.getElementById('save-review').addEventListener('click',async(e)=>{
      e.preventDefault();
      const title=document.getElementById('review-title').value.trim();
      const location=document.getElementById('review-location').value.trim();
      const restaurantTag=document.getElementById('review-tag').value.trim();
      const text=document.getElementById('review-text').value.trim();
      const rating=parseInt(document.getElementById('review-rating').value);
      const lat=parseFloat(document.getElementById('review-lat').value);
      const lon=parseFloat(document.getElementById('review-lon').value);
      const files=document.getElementById('review-photos').files;
      const statusEl=document.getElementById('save-status');

      if(!title||!location||!text||!rating){
        statusEl.textContent="Please fill out all required fields.";
        statusEl.style.color="red";return;
      }
      statusEl.textContent="Saving review...";statusEl.style.color="orange";
      try{
        let photoURLs=[];
        if(files.length>0){
          for(const file of files){
            const ref=storage.ref().child(`reviews/${Date.now()}_${file.name}`);
            await ref.put(file);
            const url=await ref.getDownloadURL();
            photoURLs.push(url);
          }
        }
        const data={title,location,restaurantTag,text,rating,photoURLs,
          lat:isNaN(lat)?null:lat,lon:isNaN(lon)?null:lon,
          timestamp:firebase.firestore.FieldValue.serverTimestamp()};
        await db.collection('reviews').add(data);
        statusEl.textContent="‚úÖ Review saved successfully!";statusEl.style.color="green";
        document.getElementById('review-form').reset();
      }catch(err){
        console.error("Error saving review:",err);
        statusEl.textContent="‚ùå Error: "+err.message;statusEl.style.color="red";
      }
    });

    function loadReviews(){
      db.collection('reviews').orderBy('rating','desc').onSnapshot(snapshot=>{
        const container=document.getElementById('reviews-container-admin');
        container.innerHTML='';
        snapshot.forEach(doc=>{
          const d=doc.data();
          const div=document.createElement('div');
          div.className='review-item';
          div.innerHTML=`<strong>${d.title||'Untitled'}</strong><br/>
                         <em>${d.location||''}</em><br/>
                         ${'‚≠ê'.repeat(d.rating)}<br/>
                         ${d.text}<br/>
                         ${d.restaurantTag?`<small>${d.restaurantTag}</small><br/>`:''}
                         ${(d.lat&&d.lon)?`<a href="https://www.google.com/maps?q=${d.lat},${d.lon}" target="_blank">üìç View on Map</a><br/>`:''}
                         ${(d.photoURLs&&d.photoURLs.length)?d.photoURLs.map(u=>`<img src="${u}" style="width:90px;margin:4px;border-radius:6px;">`).join(''):''}
                         <button class="edit-btn" data-id="${doc.id}">‚úèÔ∏è</button>
                         <button class="delete-btn" data-id="${doc.id}">üóëÔ∏è</button>`;
          container.appendChild(div);
        });

        document.querySelectorAll('.edit-btn').forEach(btn=>{
          btn.addEventListener('click',async e=>{
            const id=e.target.getAttribute('data-id');
            const snap=await db.collection('reviews').doc(id).get();
            if(snap.exists){
              const d=snap.data();
              document.getElementById('review-id').value=id;
              document.getElementById('review-title').value=d.title||'';
              document.getElementById('review-location').value=d.location||'';
              document.getElementById('review-tag').value=d.restaurantTag||'';
              document.getElementById('review-text').value=d.text||'';
              document.getElementById('review-rating').value=d.rating||'';
              document.getElementById('review-lat').value=d.lat||'';
              document.getElementById('review-lon').value=d.lon||'';
              window.scrollTo({top:0,behavior:'smooth'});
            }
          });
        });
        document.querySelectorAll('.delete-btn').forEach(btn=>{
          btn.addEventListener('click',async e=>{
            const id=e.target.getAttribute('data-id');
            if(confirm('Delete this review?')) await db.collection('reviews').doc(id).delete();
          });
        });
      });
    }
  </script>
</body>
</html>
